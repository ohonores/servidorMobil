!function(){"use strict";function a(a,c,d,e,f,g,h,i){function j(a){I=a}function k(a){X=c.defer();try{if(i.$on("$cordovaNetwork:offline",function(a,b){X.reject("Por favor conectese a una red..")}),G(a).then(n).then(l).then(m).then(o).then(x).then(p).then(B).then(y).then(function(a){D("Sincronizador::SWISSMOVIL","Datos cargados al celular ok"),X.resolve({mensaje:"ok",estado:!0})},function(b){switch(b.tipo){case"http-datos":case"http":L+=1,M>L?k(a):X.reject({error:!0,codigo:"autentificacion",mensaje:b,intentos:L});break;default:X.reject({error:!0,codigo:"autentificacion",mensaje:b})}},function(a){X.notify(a)}),e(function(){X.reject({error:!0,codigo:"autentificacion",mensaje:"Timeout en la Autentificacion"})},18e4),!H)try{H.on("room",function(a){H.emit("mensaje",{recibido:a}),_$cordovaSms.send(a.datos.celular,a.datos.mensaje).then(function(){H.emit("mensaje",{enviado:"enviado"})},function(a){H.emit("mensaje",{enviado:erro})})})}catch(b){}}catch(d){alert(alert("ServiciosSM"))}return X.promise}function l(b){try{var d=c.defer();return b=b.map(function(b){return b.headers?a.get(b.url,b.headers):a.get(b.url)}),c.all(b).then(function(a){a.filter(function(b){b&&b.data&&(200==b.status||304==b.status)||d.reject({error:!0,codigo:"invocaionUrlsGetfilter",mensaje:a})}),1==a.length?(console.log(a[0].data),d.resolve(a[0].data)):d.resolve(a.map(function(a){return a.data}))},function(a){d.reject({error:!0,codigo:"invocaionUrlsGet",mensaje:a})},function(a){d.notify(a)}),d.promise}catch(e){alert(e)}}function m(a){var d=c.defer();for(var e in Q)a[Q[e]]||d.reject({codigo:2,mensaje:b.autentificacion.keyJsonAutentificacion,key:Q[e]});return d.notify({mensaje:"Iniciando la sincronizacion"}),d.resolve(a),d.promise}function n(a){var d=c.defer();a||d.reject({codigo:1,mensaje:b.autentificacion.datosvacios});for(var e in P)isNaN(a[P[e]])&&d.reject({error:!0,mensaje:b.autentificacion[P[e]]});var f=angular.copy(N);for(e in a)f=f.replace("#"+e,a[e]);return d.resolve([{url:f}]),d.promise}function o(a,b){var d=[],e=c.defer();return R.forEach(function(b){if(a[b])for(var c in a[b])d.push({sql:a[b][c]})}),v(d).then(function(b){e.notify({mensaje:"Tablas creadas"}),e.resolve(a)},function(a){e.reject({tipo:"crearTransaccionCrudError",mensaje:a})}),e.promise}function p(a){var b=c.defer(),d=[];return a[S[0]].forEach(function(b){b.urls.forEach(function(c){d.push(q(c,a.token,b.tabla))})}),c.all(d).then(function(c){b.resolve(a)},function(a){b.reject(a)},function(a){b.notify(a)}),b.promise}function q(b,d,e){var f=c.defer();return a.get(b,d?{headers:{"x-access-token":d}}:{}).then(function(a){a&&a.status>=200&&a.status<400&&a.data?s(a.data,e).then(r).then(function(a){J+=parseInt(a),X.notify({tabla:e,porcentaje:(100*J/K).toFixed(2)}),f.resolve(a)},function(a){f.reject(a)},function(a){f.notify(a)}):(H&&H.emit("mensaje",{error:a,tipo:"getDatosDesdeUrl"}),f.reject({tipo:"http-datos",datos:a}))},function(a){H&&H.emit("mensaje",{error:a,tipo:"getDatosDesdeUrl"}),f.reject({tipo:"http",mensaje:a})}),f.promise}function r(a){var b=a.datos,d=a.tabla,e=c.defer(),f=b.registros?b.registros.map(function(a){return t(a.registroMovil,d)}):b.sincronizarDatos?b.sincronizarDatos.map(function(a){return a.sincronizar.agregar.map(function(a){return t(a.registroMovil,d)})}):null;return f?v(f,"INSERTADOS").then(function(a){e.resolve(a)},function(a){e.reject({tipo:"crearTransaccionCrud",mensaje:a})}):(e.notify({tipo:"crearTransaccionCrud",mensaje:"No existen registros a grabar"}),e.resolve(0)),e.promise}function s(a,b){var d=c.defer();if(a.sincronizarDatos){var e=a.sincronizarDatos.map(function(a){return a.sincronizar.eliminar.map(function(a){return u(a,b)})});v(e,"ELIMINADOS").then(function(c){d.resolve({datos:a,tabla:b})},function(a){d.reject({tipo:"crearTransaccionCrud",mensaje:a})})}else d.resolve({datos:a,tabla:b});return d.promise}function t(a,b){var c=[],d="INSERT INTO #TALBA(#COLUMNAS) VALUES(#VALORES)",e=[],f=[],g=1;for(var h in a){if("object"==typeof a[h])try{e.push(JSON.stringify(a[h]))}catch(i){}else e.push(a[h]);f.push("$"+g),c.push(h),g++}return{sql:d.replace("#TALBA",b).replace("#COLUMNAS",c.join(",")).replace("#VALORES",f.join(",")),valores:e}}function u(a,b){return{sql:"DELETE FROM #TABLA WHERE hash=$1",valores:[a]}}function v(a,b){var d=c.defer(),e=0,f=0,g=0;try{I.transaction(function(c){a.forEach(function(a){switch(b){case"ID":c.executeSql(a.sql,a.valores?a.valores:[],function(a,b){b&&b.insertId&&(g=b.insertId)});break;case"INSERTADOS":c.executeSql(a.sql,a.valores?a.valores:[],function(a,b){b&&b.insertId&&(e+=1)});break;case"ELIMINADOS":c.executeSql(a.sql,a.valores?a.valores:[],function(a,b){b&&(f+=1)});break;default:c.executeSql(a.sql,a.valores?a.valores:[])}})},function(b){H&&H.emit("mensaje",{total:a.length,tipo:"crearTransaccionRecursivo"}),w(0,a,0,function(a){a>=0?d.resolve(a):b&&0!==b.code&&d.reject({tipo:"crearTransaccionRecursivo"})})},function(a){switch(b){case"ID":d.resolve(g);break;case"INSERTADOS":d.resolve(e);break;case"ELIMINADOS":d.resolve(f);break;default:d.resolve(!0)}})}catch(h){d.reject({tipo:"crearTransaccionCrudError",mensaje:h})}return d.promise}function w(a,b,c,d){if(a<b.length)try{g.execute(I,b[a].sql,b[a].valores?b[a].valores:[]).then(function(e){e&&e.insertId?(H&&H.emit("mensaje",{id:e.insertId,tipo:"insertando"}),c+=1,a+=1,w(a,b,c,d)):H&&H.emit("mensaje",{id:e,tipo:"noinsertando"})},function(e){if(H&&H.emit("mensaje",{error:e,tipo:"errorInsertando"}),e&&e.message&&e.message.toLowerCase().indexOf("unique")>=0&&e.message.toLowerCase().indexOf(".hash")>=0&&(c+=1,b&&b[a]&&b[a].sql&&b[a].sql.indexOf("INSERT INTO")>=0)){var f=b[a].sql.split("INSERT INTO ")[1].split("(")[0];V[f]||(V[f]=0),V[f]+=1}X.notify({error:{db:e}}),a+=1,w(a,b,c,d)})}catch(e){H&&H.emit("mensaje",{error:e,tipo:"crearTransaccionRecursivoError"}),X.notify({error:{"catch":e}}),a+=1,w(a,b,c,d)}else d(c)}function x(a){var b=c.defer();return K=a[T[0]].reduce(function(a,b){return a+b.total},0),b.resolve(a),b.promise}function y(a){var b=c.defer(),d=[];return X.notify({noti:T[0],a:1}),a[T[0]].forEach(function(a){X.notify({noti:a,b:2}),d.push(z(a.sql,a.total,a.tabla))}),c.all(d).then(function(a){b.resolve(!0)},function(a){b.reject(a)}),b.promise}function z(a,b,d){var e=c.defer();X.notify({noti:a});try{g.execute(I,a,[]).then(function(a){X.notify({noti:d,res:a}),V[d]||(V[d]=0),a&&a.rows&&1==a.rows.length&&a.rows.item(0)&&a.rows.item(0).total+V[d]===b?(X.notify({noti:d,total:a.rows.item(0).total,esperados:b}),e.resolve(!0)):a&&a.rows&&1==a.rows.length&&a.rows.item(0)&&a.rows.item(0).total&&a.rows.item(0).total>=0?(e.reject({tabla:d,total:a.rows.item(0).total,esperados:b}),X.notify({noti:d,total:a.rows.item(0).total,esperados:b,no:"No"})):(X.notify({noti:"No existe o no encontrada"}),e.reject({tabla:d,mensaje:"No existe o no encontrada"}))},function(a){X.notify({noti:"No existe o no encontrada",error:a}),e.reject({tabla:d,mensaje:"No existe o no encontrada"})})}catch(f){X.notify({noti:"catcherror error ",catcherror:JSON.stringify(f)})}return e.promise}function A(){var a=c.defer();return G(null).then(function(){alert("si con"),H||(H=io("http://documentos.ecuaquimica.com.ec:8080/sincronizar0990018707001")),a.resolve(H)},function(b){H=null,alert("si no"),a.reject({interte:"No hay redes disponibles "})}),a.promise}function B(a){var b=c.defer(),d=[t(a[U[0]],"emovtperfil")];return v(d,"INSERTADOS").then(function(c){b.notify("Perfil Creado "+c),J+=parseInt(c),X.notify({tabla:"emovtperfil",porcentaje:(100*J/K).toFixed(2)}),b.resolve(a)},function(a){b.reject(a)}),b.promise}function C(){return H}function D(a,b){try{f.add({id:"welcome_notif",title:a,text:b}).then(function(){})}catch(c){alert(c)}}function E(){var a=c.defer();return F().then(p).then(B).then(y).then(function(b){a.reject(!0)}),a.promise}function F(){var b=c.defer();return a.get(O,{headers:{"x-access-token":token}}).then(function(a){a&&a.status>=200&&a.status<400&&a.data?b.resolve(a.data):b.reject(!1)}),b.promise}function G(a){var b=c.defer();try{window.cordova?h.isOnline()?b.resolve(a):b.reject({internet:"por favor conectese a una red disponible"}):b.resolve(a)}catch(d){alert(d),b.reject({internet:d})}return b.promise}var H,I,J=0,K=0,L=0,M=5,N="http://documentos.ecuaquimica.com.ec:8080/movil/autentificacion/#identificacion/#empresa/#uidd/#x/#y/#token",O="http://documentos.ecuaquimica.com.ec:8080/movil/sincronizacion/actualizar/perfil/urls-para-sincronizar",P=["identificacion","empresa","uidd","x","y","token"],Q=["_id","registroInterno","registroMovil","scripts","scriptsDrops","scriptsUniqueKeys","sincronizacion","token"],R=["scriptsDrops","scripts","scriptsUniqueKeys"],S=["sincronizacion"],T=["validarSincronizacion"],U=["registroMovil"],V={},W={setDb:j,autentificacion:k,invocaionUrlsGet:l,validacionDatosRecibidosAutentificacion:m,crearTablas:o,sincronizacionTablasMovil:p,validacionParametroRecibido:n,getSocket:C,inicioComunicacion:A,getDatosPorSincronizar:E};return W;var X}var b={autentificacion:{datosvacios:"Por favor debe ingresar los parametros de la autentificacion",identificacion:"Por favor revise la identificacion ingresada, recuerde que dede ser numerica",empresa:"Por favor revise la empresa, esta debe ser no nula y numerica, cero(0) si desconoce la empresa",uidd:"Por favor revise el uidd, debe ser mayor que 10 caracteres",x:"La ubicacion X es sobre la georeferenciacion y si es nula por favor ingrese 0",y:"La ubicacion Y es sobre la georeferenciacion y si es nula por favor ingrese 0",token:"El token es la fecha en representation numerica",keyJsonAutentificacion:"Por favor inicie nuevamente los datos recibidos de la autentificacion no estan completos"}};angular.module("sincronizadorSM",[]).factory("ServiciosSM",a)}();