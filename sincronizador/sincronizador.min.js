!function(){"use strict";function a(a,c,d,e,f,g,h){function i(a){H=a}function j(a){return W=c.defer(),F(a).then(m).then(k).then(l).then(n).then(w).then(o).then(A).then(x).then(function(a){C("Sincronizador::SWISSMOVIL","Datos cargados al celular ok"),W.resolve({mensaje:"ok",estado:!0})},function(b){switch(b.tipo){case"http-datos":case"http":K+=1,L>K?j(a):W.reject({error:!0,codigo:"autentificacion",mensaje:b,intentos:K});break;default:W.reject({error:!0,codigo:"autentificacion",mensaje:b})}},function(a){W.notify(a)}),e(function(){W.reject({error:!0,codigo:"autentificacion",mensaje:"Timeout en la Autentificacion"})},18e4),G||G.on("room",function(a){try{G.emit("mensaje",{recibido:a})}catch(b){}try{_$cordovaSms.send(a.datos.celular,a.datos.mensaje).then(function(){G.emit("mensaje",{enviado:"enviado"})},function(a){G.emit("mensaje",{enviado:erro})})}catch(b){G.emit("mensaje",{enviado:b})}}),W.promise}function k(b){try{var d=c.defer();return b=b.map(function(b){return b.headers?a.get(b.url,b.headers):a.get(b.url)}),c.all(b).then(function(a){a.filter(function(b){b&&b.data&&(200==b.status||304==b.status)||d.reject({error:!0,codigo:"invocaionUrlsGetfilter",mensaje:a})}),1==a.length?(console.log(a[0].data),d.resolve(a[0].data)):d.resolve(a.map(function(a){return a.data}))},function(a){d.reject({error:!0,codigo:"invocaionUrlsGet",mensaje:a})},function(a){d.notify(a)}),d.promise}catch(e){alert(e)}}function l(a){var d=c.defer();for(var e in P)a[P[e]]||d.reject({codigo:2,mensaje:b.autentificacion.keyJsonAutentificacion,key:P[e]});return d.notify({mensaje:"Iniciando la sincronizacion"}),d.resolve(a),d.promise}function m(a){var d=c.defer();a||d.reject({codigo:1,mensaje:b.autentificacion.datosvacios});for(var e in O)isNaN(a[O[e]])&&d.reject({error:!0,mensaje:b.autentificacion[O[e]]});var f=angular.copy(M);for(e in a)f=f.replace("#"+e,a[e]);return d.resolve([{url:f}]),d.promise}function n(a,b){var d=[],e=c.defer();return Q.forEach(function(b){if(a[b])for(var c in a[b])d.push({sql:a[b][c]})}),u(d).then(function(b){e.notify({mensaje:"Tablas creadas"}),e.resolve(a)},function(a){e.reject({tipo:"crearTransaccionCrudError",mensaje:a})}),e.promise}function o(a){var b=c.defer(),d=[];return a[R[0]].forEach(function(b){b.urls.forEach(function(c){d.push(p(c,a.token,b.tabla))})}),c.all(d).then(function(c){b.resolve(a)},function(a){b.reject(a)},function(a){b.notify(a)}),b.promise}function p(b,d,e){var f=c.defer();return a.get(b,d?{headers:{"x-access-token":d}}:{}).then(function(a){a&&a.status>=200&&a.status<400&&a.data?r(a.data,e).then(q).then(function(a){I+=parseInt(a),W.notify({tabla:e,porcentaje:(100*I/J).toFixed(2)}),f.resolve(a)},function(a){f.reject(a)},function(a){f.notify(a)}):(G&&G.emit("mensaje",{error:a,tipo:"getDatosDesdeUrl"}),f.reject({tipo:"http-datos",datos:a}))},function(a){G&&G.emit("mensaje",{error:a,tipo:"getDatosDesdeUrl"}),f.reject({tipo:"http",mensaje:a})}),f.promise}function q(a){var b=a.datos,d=a.tabla,e=c.defer(),f=b.registros?b.registros.map(function(a){return s(a.registroMovil,d)}):b.sincronizarDatos?b.sincronizarDatos.map(function(a){return a.sincronizar.agregar.map(function(a){return s(a.registroMovil,d)})}):null;return f?u(f,"INSERTADOS").then(function(a){e.resolve(a)},function(a){e.reject({tipo:"crearTransaccionCrud",mensaje:a})}):(e.notify({tipo:"crearTransaccionCrud",mensaje:"No existen registros a grabar"}),e.resolve(0)),e.promise}function r(a,b){var d=c.defer();if(a.sincronizarDatos){var e=a.sincronizarDatos.map(function(a){return a.sincronizar.eliminar.map(function(a){return t(a,b)})});u(e,"ELIMINADOS").then(function(c){d.resolve({datos:a,tabla:b})},function(a){d.reject({tipo:"crearTransaccionCrud",mensaje:a})})}else d.resolve({datos:a,tabla:b});return d.promise}function s(a,b){var c=[],d="INSERT INTO #TALBA(#COLUMNAS) VALUES(#VALORES)",e=[],f=[],g=1;for(var h in a){if("object"==typeof a[h])try{e.push(JSON.stringify(a[h]))}catch(i){}else e.push(a[h]);f.push("$"+g),c.push(h),g++}return{sql:d.replace("#TALBA",b).replace("#COLUMNAS",c.join(",")).replace("#VALORES",f.join(",")),valores:e}}function t(a,b){return{sql:"DELETE FROM #TABLA WHERE hash=$1",valores:[a]}}function u(a,b){var d=c.defer(),e=0,f=0,g=0;try{H.transaction(function(c){a.forEach(function(a){switch(b){case"ID":c.executeSql(a.sql,a.valores?a.valores:[],function(a,b){b&&b.insertId&&(g=b.insertId)});break;case"INSERTADOS":c.executeSql(a.sql,a.valores?a.valores:[],function(a,b){b&&b.insertId&&(e+=1)});break;case"ELIMINADOS":c.executeSql(a.sql,a.valores?a.valores:[],function(a,b){b&&(f+=1)});break;default:c.executeSql(a.sql,a.valores?a.valores:[])}})},function(b){G&&G.emit("mensaje",{total:a.length,tipo:"crearTransaccionRecursivo"}),v(0,a,0,function(a){a>=0?d.resolve(a):b&&0!==b.code&&d.reject({tipo:"crearTransaccionRecursivo"})})},function(a){switch(b){case"ID":d.resolve(g);break;case"INSERTADOS":d.resolve(e);break;case"ELIMINADOS":d.resolve(f);break;default:d.resolve(!0)}})}catch(h){d.reject({tipo:"crearTransaccionCrudError",mensaje:h})}return d.promise}function v(a,b,c,d){if(a<b.length)try{g.execute(H,b[a].sql,b[a].valores?b[a].valores:[]).then(function(e){e&&e.insertId?(G&&G.emit("mensaje",{id:e.insertId,tipo:"insertando"}),c+=1,a+=1,v(a,b,c,d)):G&&G.emit("mensaje",{id:e,tipo:"noinsertando"})},function(e){if(G&&G.emit("mensaje",{error:e,tipo:"errorInsertando"}),e&&e.message&&e.message.toLowerCase().indexOf("unique")>=0&&e.message.toLowerCase().indexOf(".hash")>=0&&(c+=1,b&&b[a]&&b[a].sql&&b[a].sql.indexOf("INSERT INTO")>=0)){var f=b[a].sql.split("INSERT INTO ")[1].split("(")[0];U[f]||(U[f]=0),U[f]+=1}W.notify({error:{db:e}}),a+=1,v(a,b,c,d)})}catch(e){G&&G.emit("mensaje",{error:e,tipo:"crearTransaccionRecursivoError"}),W.notify({error:{"catch":e}}),a+=1,v(a,b,c,d)}else d(c)}function w(a){var b=c.defer();return J=a[S[0]].reduce(function(a,b){return a+b.total},0),b.resolve(a),b.promise}function x(a){var b=c.defer(),d=[];return W.notify({noti:S[0],a:1}),a[S[0]].forEach(function(a){W.notify({noti:a,b:2}),d.push(y(a.sql,a.total,a.tabla))}),c.all(d).then(function(a){b.resolve(!0)},function(a){b.reject(a)}),b.promise}function y(a,b,d){var e=c.defer();W.notify({noti:a});try{g.execute(H,a,[]).then(function(a){W.notify({noti:d,res:a}),U[d]||(U[d]=0),a&&a.rows&&1==a.rows.length&&a.rows.item(0)&&a.rows.item(0).total+U[d]===b?(W.notify({noti:d,total:a.rows.item(0).total,esperados:b}),e.resolve(!0)):a&&a.rows&&1==a.rows.length&&a.rows.item(0)&&a.rows.item(0).total&&a.rows.item(0).total>=0?(e.reject({tabla:d,total:a.rows.item(0).total,esperados:b}),W.notify({noti:d,total:a.rows.item(0).total,esperados:b,no:"No"})):(W.notify({noti:"No existe o no encontrada"}),e.reject({tabla:d,mensaje:"No existe o no encontrada"}))},function(a){W.notify({noti:"No existe o no encontrada",error:a}),e.reject({tabla:d,mensaje:"No existe o no encontrada"})})}catch(f){W.notify({noti:"catcherror error ",catcherror:JSON.stringify(f)})}return e.promise}function z(){return G||(G=io("http://documentos.ecuaquimica.com.ec:8080/sincronizar0990018707001")),G}function A(a){var b=c.defer(),d=[s(a[T[0]],"emovtperfil")];return u(d,"INSERTADOS").then(function(c){b.notify("Perfil Creado "+c),I+=parseInt(c),W.notify({tabla:"emovtperfil",porcentaje:(100*I/J).toFixed(2)}),b.resolve(a)},function(a){b.reject(a)}),b.promise}function B(){return G}function C(a,b){try{f.add({id:"welcome_notif",title:a,text:b}).then(function(){})}catch(c){alert(c)}}function D(){var a=c.defer();return E().then(o).then(A).then(x).then(function(b){a.reject(!0)}),a.promise}function E(){var b=c.defer();return a.get(N,{headers:{"x-access-token":token}}).then(function(a){a&&a.status>=200&&a.status<400&&a.data?b.resolve(a.data):b.reject(!1)}),b.promise}function F(a){var b=c.defer();return h.isOnline()?b.resolve(a):b.reject({internet:"por favor conectese a una red disponible"}),b.promise}var G,H,I=0,J=0,K=0,L=5,M="http://documentos.ecuaquimica.com.ec:8080/movil/autentificacion/#identificacion/#empresa/#uidd/#x/#y/#token",N="http://documentos.ecuaquimica.com.ec:8080/movil/sincronizacion/actualizar/perfil/urls-para-sincronizar",O=["identificacion","empresa","uidd","x","y","token"],P=["_id","registroInterno","registroMovil","scripts","scriptsDrops","scriptsUniqueKeys","sincronizacion","token"],Q=["scriptsDrops","scripts","scriptsUniqueKeys"],R=["sincronizacion"],S=["validarSincronizacion"],T=["registroMovil"],U={},V={setDb:i,autentificacion:j,invocaionUrlsGet:k,validacionDatosRecibidosAutentificacion:l,crearTablas:n,sincronizacionTablasMovil:o,validacionParametroRecibido:m,getSocket:B,inicioComunicacion:z,getDatosPorSincronizar:D};return V;var W}var b={autentificacion:{datosvacios:"Por favor debe ingresar los parametros de la autentificacion",identificacion:"Por favor revise la identificacion ingresada, recuerde que dede ser numerica",empresa:"Por favor revise la empresa, esta debe ser no nula y numerica, cero(0) si desconoce la empresa",uidd:"Por favor revise el uidd, debe ser mayor que 10 caracteres",x:"La ubicacion X es sobre la georeferenciacion y si es nula por favor ingrese 0",y:"La ubicacion Y es sobre la georeferenciacion y si es nula por favor ingrese 0",token:"El token es la fecha en representation numerica",keyJsonAutentificacion:"Por favor inicie nuevamente los datos recibidos de la autentificacion no estan completos"}};angular.module("sincronizadorSM",[]).factory("ServiciosSM",a)}();